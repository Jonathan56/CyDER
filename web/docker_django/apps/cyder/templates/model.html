{% extends "_base.html" %}
{% block content %}

<script src="https://maps.googleapis.com/maps/api/js"></script>
<script src="https://d3js.org/d3.v4.min.js"></script>

<div style="max-width: 500px; margin: 0 auto;">
  <!-- <div class="text-center">
    <br>
    <img src="http://sdtimes.com/wp-content/uploads/2015/11/logo.png" style="width:304px;height:228px;">
    <br>
  </div> -->

  <br>

  <div class="text-center">
    <h1><b>CyDER</b></h1>
    <p>Distribution grid model:</p>
  </div>

  <div style="text-align:left;">
    <ul style="list-style-position: inside;">
      <li>Id: {{ model.id }}</li>
      <li>Region: {{ model.region }}</li>
      <li>Area: {{ model.area }}</li>
      <li>City: {{ model.city }}</li>
      <!-- <li>Latitude: {{ model.lat }}</li>
      <li>Longitude: {{ model.lon }}</li>
      <li>Filename: {{ model.filename }}</li> -->
      <li>Breaker name: {{ model.breaker_name }}</li>
    </ul>
  </div>

  <br>

  <div class="text-center">
    <p>Last calibrations:</p>
  </div>

  <div style="text-align:left;">
    <ul style="list-style-position: inside;">
      {% for value in history %}
      <li>{{ value.date|date:"M d, Y" }} | ZA={{ value.z_a|floatformat:-2 }}
        ZB={{ value.z_b|floatformat:-2 }} ZC={{ value.z_c|floatformat:-2 }}
        <a href="/calibration/{{ value.id }}">more details</a>
      </li>
      {% endfor %}
    </ul>
  </div>
  <br>
  <br>
</div>

  <div id="locations-map" style="width: 70%; height: 500px; margin: 0 auto; border:6px solid #E4E4E4;"></div>

  <br>

  <script type="text/javascript">
  var url = "/api/nodes/get/{{ model.id }}";
  var data
  d3.json(url, function (json) {
    // Save data in global scope
    data = json

    // Create google coodinate objects
    data.nodes.forEach(function(d) {
      d.LatLng = new google.maps.LatLng(parseFloat(d.latitude), parseFloat(d.longitude));
    });

    // Create the map :)
    var map = initMap();

    // Function to initialize the map
    function initMap() {
        // create bounds, which will extend to cover all location markers
        var bound = new google.maps.LatLngBounds();
        data.nodes.forEach(function(d) {
            bound.extend(d['LatLng']);
        });
        var map = new google.maps.Map(document.getElementById('locations-map'), {
            // center the map at the center of all the markers
            // the style and control types are copied from the trips page map
            center: bound.getCenter(),
            mapTypeId: google.maps.MapTypeId.TERRAIN,
            panControl: true,
            scrollwheel: false,
            mapTypeControl: false,
            panControlOptions: {
                position: google.maps.ControlPosition.RIGHT_CENTER
            },
            zoomControl: true,
            zoomControlOptions: {
                style: google.maps.ZoomControlStyle.LARGE,
                position: google.maps.ControlPosition.RIGHT_CENTER
            },
            scaleControl: true,
            streetViewControl: false,
            zoom: 1 // overridden with map.fitBounds below
        });
        map.fitBounds(bound);

        data.nodes.forEach(function(d) {
          var marker = new google.maps.Marker({
            position: d.LatLng,
            map: map,
            description: "<p>Node: " + d.node_id + "</p>",
          });

          google.maps.event.addListener(marker, 'click', function() {
           var infowindow = new google.maps.InfoWindow({
             content: marker.description,
           });
           infowindow.open(map, marker);
          });

        });

        return map; // return the map to be used later
    }

  });
  </script>

  <div class="text-center">
    <a class="button1" href="/api/model/calibrate/{{ model.id }}">Calibrate</a>
    <a class="button1" href="/api/my_models/add/{{ model.id }}">Add model</a>
  </div>


{% endblock content %}
