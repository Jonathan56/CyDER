{% extends "_base.html" %}
{% block content %}

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.4.3/d3.js" charset="utf-8"></script>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/spin.js/2.0.1/spin.min.js'></script>
<script src="/static/bootstrap3_datetime/js/moment.min.js"></script>


<div style="max-width: 500px; margin: 0 auto;">

  <div class="text-center">
    <h1><b>CyDER</b></h1>
    <p>Query uPMU data</p>
    <br>
  </div>
</div>

<div id="graph" style="width: 70%; height: 500px; margin: 0 auto;"></div>
<div id="graph2" style="width: 70%; height: 500px; margin: 0 auto;"></div>

<div class="text-center">
  <p>Take me back to the main menu</p>
  <a class="button3" href="/home/">Back</a>
</div>

<script>
  // loader settings
  var opts = {
    lines: 9, // The number of lines to draw
    length: 9, // The length of each line
    width: 5, // The line thickness
    radius: 14, // The radius of the inner circle
    color: '#EE3124', // #rgb or #rrggbb or array of colors
    speed: 1.9, // Rounds per second
    trail: 40, // Afterglow percentage
    className: 'spinner', // The CSS class to assign to the spinner
  };

  // trigger loader
  var target = document.getElementById("graph");
  var spinner = new Spinner(opts).spin(target);

   // Get today's date
   var first_date = moment().subtract(1, 'hours').format("YYYY-MM-DD_HH:mm:ss");
   var second_date = moment().subtract(10, 'minutes').format("YYYY-MM-DD_HH:mm:ss");
   var api_url = String('/api2/upmu/' + String(first_date) + '/' + String(second_date) + '/grizzly_bus1/');
   console.log(api_url);

  d3.json(api_url, function(error, json) {
    if (error) return console.warn(error);

    // stop spin.js loader
    spinner.stop();

    var x = [];
    var y1 = [];
    var y2 = [];
    var y3 = [];
    var w1 = [];
    var w2 = [];
    var w3 = [];

    json.data.forEach(function(d){
      x.push(d.datetime);
      y1.push(d.P_A)
      y2.push(d.P_B)
      y3.push(d.P_C)
      w1.push(d.Q_A)
      w2.push(d.Q_B)
      w3.push(d.Q_C)

    });

    var trace = {
      x: x,
      y: y1,
      name: 'Phase A',
      mode: 'lines+markers',
      type: 'scatter'
    };

    var trace2 = {
      x: x,
      y: y2,
      name: 'Phase B',
      mode: 'lines+markers',
      type: 'scatter'
    };

    var trace3 = {
      x: x,
      y: y3,
      name: 'Phase C',
      mode: 'lines+markers',
      type: 'scatter'
    };

    var layout = {
      title: 'Active Power',
      xaxis: {title: 'Time'},
      yaxis: {title: 'Power (kW)'},
    };

    var data = [trace, trace2, trace3];

    var wtrace = {
      x: x,
      y: w1,
      name: 'Phase A',
      mode: 'lines+markers',
      type: 'scatter'
    };

    var wtrace2 = {
      x: x,
      y: w2,
      name: 'Phase B',
      mode: 'lines+markers',
      type: 'scatter'
    };

    var wtrace3 = {
      x: x,
      y: w3,
      name: 'Phase C',
      mode: 'lines+markers',
      type: 'scatter'
    };

    var wlayout = {
      title: 'Reactive Power',
      xaxis: {title: 'Time'},
      yaxis: {title: 'Power (kW)'},
    };

    var wdata = [wtrace, wtrace2, wtrace3];

    Plotly.newPlot('graph', data, layout);
    Plotly.newPlot('graph2', wdata, wlayout);
  });
</script>


{% endblock content %}
